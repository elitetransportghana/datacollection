<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Transport | Pro Portal</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        elite: {
                            base: '#050505',    // Deeper Black
                            card: '#0D0D0D',    // Standard Black
                            green: '#184040',   // Brand Green
                            light: '#235c5c',   // Highlight
                            gold: '#D4AF37',    // Luxury Accent
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #235c5c; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #184040; }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(13, 13, 13, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(35, 92, 92, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .elite-input-group { position: relative; }
        
        .elite-input {
            width: 100%;
            background: rgba(24, 64, 64, 0.3);
            border: 1px solid rgba(35, 92, 92, 0.5);
            border-radius: 0.5rem;
            padding: 0.85rem 1rem;
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .elite-input:focus {
            outline: none;
            border-color: #D4AF37; /* Gold focus */
            background: rgba(24, 64, 64, 0.6);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1);
        }
        .elite-input::placeholder { color: #6b7280; }

        /* Button Gradients */
        .btn-primary {
            background: linear-gradient(135deg, #f3f4f6 0%, #d1d5db 100%);
            color: #0D0D0D;
            font-weight: 600;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
        }
        
        .nav-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .nav-btn.active {
            background: rgba(35, 92, 92, 0.4);
            border: 1px solid #235c5c;
            color: white;
            box-shadow: 0 0 15px rgba(35, 92, 92, 0.2);
        }
        .nav-btn:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
            color: #D4AF37;
        }
        
        /* Mobile Tweaks */
        @media (max-width: 640px) {
            .glass-panel { padding: 1.5rem; }
            .nav-btn { padding: 0.5rem 1rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body class="bg-elite-base text-gray-200 min-h-screen font-sans selection:bg-elite-gold selection:text-black" x-data="app()">

    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-elite-green/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-elite-gold/5 rounded-full blur-[120px]"></div>
    </div>

    <div x-show="!token" class="relative z-10 flex items-center justify-center min-h-screen p-4 md:p-6">
        <div class="w-full max-w-md glass-panel p-8 md:p-10 rounded-2xl animate-fade-in-up">
            <div class="text-center mb-8 relative">
                <div class="relative mx-auto w-fit mb-6">
                     <div class="absolute -inset-4 bg-elite-green/30 rounded-full blur-xl"></div>
                     <img src="https://firebasestorage.googleapis.com/v0/b/mealone-29b00.firebasestorage.app/o/ELITE%20TRANSPORT.png?alt=media&token=0be7bd05-6b0d-4c21-a7b4-729cda707fe3" 
                          alt="Elite Transport" class="relative h-28 md:h-32 object-contain drop-shadow-2xl mx-auto">
                </div>
                <h2 class="text-xl font-medium tracking-[0.2em] text-gray-400 uppercase">Staff Portal</h2>
            </div>
            
            <form x-show="view === 'login'" @submit.prevent="login" class="space-y-5">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Identity</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500 group-focus-within:text-elite-gold transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <input x-model="auth.username" type="text" placeholder="Enter Username" class="elite-input pl-10" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Security</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500 group-focus-within:text-elite-gold transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </div>
                        <input x-model="auth.password" type="password" placeholder="Enter Password" class="elite-input pl-10" required>
                    </div>
                </div>
                <button type="submit" class="w-full btn-primary py-3.5 rounded-lg uppercase tracking-widest text-sm mt-4">
                    Access System
                </button>
                <div class="text-center mt-4">
                    <button type="button" @click="view = 'forgot'" class="text-xs text-elite-gold hover:text-white transition">Forgot Password?</button>
                </div>
            </form>

            <div x-show="view === 'forgot'" class="space-y-5">
                <p class="text-sm text-gray-400 text-center">Enter your email address. We'll send you a link to reset your password.</p>
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Email Address</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500 group-focus-within:text-elite-green transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <input x-model="auth.username" type="email" placeholder="email@elitetransport.com" class="elite-input pl-10" required>
                    </div>
                </div>
                <button @click="sendResetLink" class="w-full bg-elite-green hover:bg-elite-light text-white font-bold py-3.5 rounded-lg uppercase tracking-widest text-sm mt-4 transition">
                    Send Reset Link
                </button>
                <div class="text-center mt-4">
                    <button type="button" @click="view = 'login'" class="text-xs text-gray-500 hover:text-white transition">Back to Login</button>
                </div>
            </div>

            <div x-show="view === 'reset'" class="space-y-5">
                 <p class="text-sm text-gray-400 text-center">Enter your new password below.</p>
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">New Password</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500 group-focus-within:text-elite-gold transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11.536 16.464l-1.414 1.414a2 2 0 01-2.828 0l-.828-.828a2 2 0 010-2.828l1.414-1.414A6 6 0 0117 9z" />
                            </svg>
                        </div>
                        <input x-model="auth.newPassword" type="text" placeholder="New Password" class="elite-input pl-10" required>
                    </div>
                </div>
                <button @click="resetPassword" class="w-full bg-elite-gold hover:bg-yellow-500 text-black font-bold py-3.5 rounded-lg uppercase tracking-widest text-sm mt-4 transition">
                    Update Password
                </button>
            </div>
            
            <div x-show="auth.error" x-transition class="mt-6 p-3 bg-red-900/30 border border-red-800/50 rounded text-red-300 text-sm text-center">
                <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span x-text="auth.error"></span>
            </div>
             <div x-show="auth.success" x-transition class="mt-6 p-3 bg-green-900/30 border border-green-800/50 rounded text-green-300 text-sm text-center">
                <span x-text="auth.success"></span>
            </div>
        </div>
    </div>

    <div x-show="token" class="relative z-10 max-w-[1400px] mx-auto p-4 md:p-8" style="display:none;">
        
        <header class="flex flex-col lg:flex-row justify-between items-center mb-10 pb-6 border-b border-white/5 gap-6 lg:gap-0">
            <div class="flex flex-col sm:flex-row items-center gap-5 text-center sm:text-left">
                <div class="relative group">
                    <div class="absolute -inset-2 bg-gradient-to-r from-elite-green to-elite-gold rounded-full opacity-30 group-hover:opacity-60 blur-lg transition duration-500"></div>
                    <img src="https://firebasestorage.googleapis.com/v0/b/mealone-29b00.firebasestorage.app/o/ELITE%20TRANSPORT.png?alt=media&token=0be7bd05-6b0d-4c21-a7b4-729cda707fe3" 
                         alt="Logo" class="relative h-24 w-24 md:h-28 md:w-28 object-contain transition-transform duration-300 hover:scale-105">
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white tracking-wide">ELITE <span class="text-elite-light font-light">TRANSPORT</span></h1>
                    <div class="flex items-center justify-center sm:justify-start gap-2 text-sm text-gray-400 mt-1">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span>Logged in as <span x-text="user.name" class="text-white font-medium"></span></span>
                    </div>
                </div>
            </div>

            <nav class="flex flex-wrap justify-center items-center gap-2 w-full lg:w-auto bg-elite-card/50 p-2 rounded-xl border border-white/5 backdrop-blur-sm">
                <button x-show="user.role !== 'worker'" 
                        @click="view = 'stats'" 
                        :class="view === 'stats' ? 'active' : ''"
                        class="nav-btn px-4 md:px-6 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span class="hidden sm:inline">Overview</span>
                    <span class="sm:hidden">Stats</span>
                </button>
                
                <button @click="view = 'entry'" 
                        :class="view === 'entry' ? 'active' : ''"
                        class="nav-btn px-4 md:px-6 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span class="hidden sm:inline">New Entry</span>
                    <span class="sm:hidden">Add</span>
                </button>
                
                <button x-show="user.role === 'main_admin'" 
                        @click="view = 'users'" 
                        :class="view === 'users' ? 'active' : ''"
                        class="nav-btn px-4 md:px-6 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Staff
                </button>
                
                <div class="w-px h-6 bg-white/10 mx-1 md:mx-2"></div>

                <button @click="logout" class="px-3 md:px-4 py-2.5 text-gray-400 hover:text-red-400 transition-colors text-sm font-medium flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="hidden sm:inline">Logout</span>
                </button>
            </nav>
        </header>

        <div x-show="view === 'entry'" class="max-w-3xl mx-auto" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            <div class="glass-panel rounded-2xl p-6 md:p-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-elite-green via-elite-gold to-elite-green"></div>
                
                <div class="flex justify-between items-end mb-8 border-b border-white/5 pb-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Record Data</h2>
                        <p class="text-sm text-gray-400 mt-1">Fill in student details accurately.</p>
                    </div>
                    <div class="text-xs text-elite-gold border border-elite-gold/30 px-2 py-1 rounded bg-elite-gold/10 hidden sm:block">
                        Secure Form
                    </div>
                </div>

                <form @submit.prevent="submitEntry" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2" x-data="{ open: false, regions: [
                            'Ahafo Region', 'Ashanti Region', 'Bono Region', 'Bono East Region', 'Central Region',
                            'Eastern Region', 'Greater Accra Region', 'North East Region', 'Northern Region', 'Oti Region',
                            'Savannah Region', 'Upper East Region', 'Upper West Region', 'Volta Region', 'Western Region', 'Western North Region'
                        ] }">
                             <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1.5 ml-1">Region of Residence</label>
                             <div class="relative">
                                <input type="text" x-model="form.address" @focus="open = true" @click.outside="open = false" class="elite-input" placeholder="Select or Search Region..." required>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                                <div x-show="open" x-transition class="absolute z-20 w-full mt-2 bg-[#121212] border border-elite-green/50 rounded-lg shadow-2xl max-h-48 overflow-y-auto">
                                    <template x-for="region in regions.filter(r => r.toLowerCase().includes(form.address.toLowerCase()))">
                                        <div @click="form.address = region; open = false" class="px-4 py-3 hover:bg-elite-green/40 cursor-pointer text-sm border-b border-white/5 last:border-0" x-text="region"></div>
                                    </template>
                                </div>
                             </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1.5 ml-1">Full Name</label>
                            <input x-model="form.name" placeholder="John Doe" class="elite-input" required>
                        </div>
                        
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1.5 ml-1">Ghana Contact</label>
                            <div class="relative">
                                <input type="tel" x-model="form.contact" placeholder="024XXXXXXX" class="elite-input" required>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2" x-data="{ open: false, options: [
                            'BA Development Education',
                            'BEd. Agricultural Science',
                            'BEd. Arabic',
                            'BEd. Basic Education',
                            'BEd. Business Studies',
                            'BEd. Early Childhood Care and Education',
                            'BEd. Family and Consumer Science',
                            'BEd. Social Science',
                            'BSc. Accounting',
                            'BSc. Actuarial Science',
                            'BSc. Agribusiness',
                            'BSc. Agriculture Technology (Agronomy)',
                            'BSc. Agriculture Technology (Animal Science)',
                            'BSc. Agriculture Technology (Biotechnology)',
                            'BSc. Agriculture Technology (Horticulture)',
                            'BSc. Agriculture Technology (Mechanization and Irrigation Technology)',
                            'BSc. Agriculture Technology (Soil Science)',
                            'BSc. Aquaculture and Fisheries Science',
                            'BSc. Banking and Finance',
                            'BSc. Biochemistry',
                            'BSc. Biological Science',
                            'BSc. Biotechnology and Molecular Biology',
                            'BSc. Business Information Systems',
                            'BSc. Chemical Science and Technology',
                            'BSc. Community Nutrition',
                            'BSc. Computer Science',
                            'BSc. Computing Mathematics',
                            'BSc. Ecotourism and Hospitality Management',
                            'BSc. Engineering Physics',
                            'BSc. Family and Consumer Science',
                            'BSc. Finance and Economics',
                            'BSc. Food Science and Technology',
                            'BSc. Food Systems',
                            'BSc. Forensic Science',
                            'BSc. Forest Resource Conservation and Management',
                            'BSc. Health Information Management',
                            'BSc. Human Resource Management',
                            'BSc. In Social Change Communication',
                            'BSc. Marketing',
                            'BSc. Mathematics',
                            'BSc. Medical Imaging Technology',
                            'BSc. Midwifery',
                            'BSc. Nurse Anaesthesia',
                            'BSc. Nurse Practitioner',
                            'BSc. Nursing',
                            'BSc. Paediatric Nursing',
                            'BSc. Physician Assistant',
                            'BSc. Procurement and Supply Chain Management',
                            'BSc. Public Administration',
                            'BSc. Statistics',
                            'Diploma In Agribusiness',
                            'Diploma In Agriculture Science Education',
                            'Diploma In Agriculture Technology',
                            'Diploma In Aquaculture and Fisheries Science',
                            'Diploma In Basic Education',
                            'Diploma In Biotechnology and Molecular Biology',
                            'Diploma In Business Administration',
                            'Diploma In Development Education Studies',
                            'Diploma In Early Childhood Care and Education',
                            'Diploma In Family and Consumer Science',
                            'Diploma In Social Change Communication',
                            'Doctor of Medical Laboratory Science',
                            'Doctor of Pharmacy',
                            'MBChB (Medicine)',
                            'Other'
                        ] }">
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1.5 ml-1">Course of Study</label>
                            <div class="relative">
                                <input type="text" x-model="form.course" @focus="open = true" @click.outside="open = false" class="elite-input" placeholder="Search or Select..." required>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                                <div x-show="open" x-transition class="absolute z-20 w-full mt-2 bg-[#121212] border border-elite-green/50 rounded-lg shadow-2xl max-h-48 overflow-y-auto">
                                    <template x-for="opt in options.filter(i => i.toLowerCase().includes(form.course.toLowerCase()))">
                                        <div @click="form.course = opt; open = false" class="px-4 py-3 hover:bg-elite-green/40 cursor-pointer text-sm border-b border-white/5 last:border-0" x-text="opt"></div>
                                    </template>
                                </div>
                            </div>
                            <div x-show="form.course === 'Other'" x-transition class="mt-4 animate-fade-in-up">
                                <label class="block text-xs uppercase tracking-wider text-elite-gold mb-1.5 ml-1">Specify Custom Course</label>
                                <input x-model="form.customCourse" placeholder="Enter course name manually..." class="elite-input border-elite-gold/50 bg-elite-gold/5 focus:border-elite-gold" :required="form.course === 'Other'">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1.5 ml-1">Level</label>
                            <select x-model="form.level" class="elite-input appearance-none bg-[#0D0D0D]">
                                <option value="" disabled selected>Select...</option>
                                <option>Level 100</option>
                                <option>Level 200</option>
                                <option>Level 300</option>
                                <option>Level 400</option>
                                <option>Level 500</option>
                                <option>Level 600</option>
                                
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="w-full btn-primary py-4 rounded-xl shadow-lg mt-8 flex justify-center items-center gap-2">
                        <span>SUBMIT RECORD</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </form>

                <div x-show="message" x-transition class="mt-6 p-4 rounded-lg flex items-center justify-center gap-3 text-sm font-medium" 
                     :class="status === 'success' ? 'bg-green-500/10 border border-green-500/30 text-green-400' : 'bg-red-500/10 border border-red-500/30 text-red-400'">
                    <div :class="status === 'success' ? 'w-2 h-2 rounded-full bg-green-500' : 'w-2 h-2 rounded-full bg-red-500'"></div>
                    <span x-text="message"></span>
                </div>
            </div>
        </div>

        <div x-show="view === 'stats'" x-init="$watch('view', v => v === 'stats' && fetchStats())" class="space-y-8" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <svg class="w-24 h-24 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Total Records</p>
                    <p class="text-5xl font-bold text-white tracking-tight" x-text="stats.totalEntries || 0"></p>
                    <div class="mt-4 flex items-center text-xs text-elite-light">
                        <span class="bg-elite-light/20 px-2 py-1 rounded">Lifetime</span>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                     <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <svg class="w-24 h-24 text-elite-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <p class="text-elite-gold text-xs font-bold uppercase tracking-widest mb-2">Today's Activity</p>
                    <p class="text-5xl font-bold text-white tracking-tight" x-text="stats.entriesToday || 0"></p>
                    <div class="mt-4 flex items-center text-xs text-elite-gold">
                        <span class="bg-elite-gold/20 px-2 py-1 rounded">Live Updates</span>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                     <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <svg class="w-24 h-24 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </div>
                    <p class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-2">Est. Population</p>
                    <p class="text-5xl font-bold text-white tracking-tight" x-text="stats.estimatedStudents || 0"></p>
                    <div class="mt-4 flex items-center text-xs text-blue-400">
                        <span class="bg-blue-900/40 px-2 py-1 rounded">Aggregated Roll</span>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-6 border-b border-white/5 pb-2">
                    <span x-text="user.role === 'main_admin' ? 'Supervisor Performance' : 'Team Output'"></span>
                </h3>
                <div class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                    <template x-for="p in stats.performance">
                        <div class="flex justify-between items-center p-3 rounded bg-white/5 hover:bg-white/10 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-elite-green flex items-center justify-center text-xs font-bold text-white" x-text="p.name.charAt(0)"></div>
                                <div>
                                    <p class="text-sm text-white font-medium" x-text="p.name"></p>
                                    <p class="text-[10px] text-gray-500 uppercase" x-text="p.role === 'main_admin' ? 'Administrator' : (p.role === 'admin' ? 'Supervisor' : 'Field Worker')"></p>
                                </div>
                            </div>
                            <span class="font-mono font-bold text-elite-gold text-lg" x-text="p.count"></span>
                        </div>
                    </template>
                    <div x-show="!stats.performance || stats.performance.length === 0" class="text-center text-gray-500 text-sm py-4">
                        No performance data available.
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-6 border-b border-white/5 pb-2">Distribution by Course</h3>
                    <div class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                        <template x-for="item in stats.byCourse">
                            <div class="flex justify-between items-center p-3 rounded bg-white/5 hover:bg-white/10 transition">
                                <span class="text-sm text-gray-300" x-text="item.course"></span>
                                <span class="font-mono font-bold text-elite-gold" x-text="item.count"></span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-6 border-b border-white/5 pb-2">Distribution by Level</h3>
                    <div class="space-y-3">
                        <template x-for="item in stats.byLevel">
                            <div class="flex items-center gap-4">
                                <span class="text-xs w-16 text-gray-400" x-text="item.level"></span>
                                <div class="flex-1 h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-elite-green" :style="`width: ${(item.count / stats.totalEntries) * 100}%`"></div>
                                </div>
                                <span class="text-xs font-bold text-white" x-text="item.count"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-6 border-b border-white/5 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400">Recent Entries Log</h3>
                    
                    <div class="flex items-center gap-2">
                        <button @click="$refs.fileInput.click()" class="text-xs bg-white/10 text-white px-3 py-1.5 rounded font-bold hover:bg-white/20 transition animate-fade-in-up">
                            Import Data
                        </button>
                        <input x-ref="fileInput" type="file" hidden accept=".csv, .xlsx, .xls" @change="handleFileUpload">

                        <button x-show="selectedIds.length > 0 && user.role !== 'worker'" 
                                @click="openDelegateModal"
                                class="text-xs bg-elite-gold text-black px-3 py-1.5 rounded font-bold hover:bg-yellow-500 transition animate-fade-in-up">
                            Delegate (<span x-text="selectedIds.length"></span>)
                        </button>
                        <button class="text-xs text-elite-green hover:text-white transition">Export Data</button>
                    </div>
                </div>

                <div class="px-6 pb-4 flex flex-wrap gap-2">
                    <select x-model="filters.course" class="bg-gray-800 text-xs text-white p-2 rounded border border-gray-700 focus:ring-0">
                        <option value="">All Courses</option>
                        <template x-for="c in uniqueCourses">
                            <option :value="c" x-text="c"></option>
                        </template>
                    </select>
                    <select x-model="filters.level" class="bg-gray-800 text-xs text-white p-2 rounded border border-gray-700 focus:ring-0">
                        <option value="">All Levels</option>
                        <template x-for="l in uniqueLevels">
                            <option :value="l" x-text="l"></option>
                        </template>
                    </select>
                    <select x-model="filters.region" class="bg-gray-800 text-xs text-white p-2 rounded border border-gray-700 focus:ring-0">
                        <option value="">All Regions</option>
                        <template x-for="r in uniqueRegions">
                            <option :value="r" x-text="r"></option>
                        </template>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-[#050505] text-xs uppercase font-semibold text-gray-500">
                            <tr>
                                <th x-show="user.role !== 'worker'" class="p-4 w-10">
                                    <input type="checkbox" @change="toggleSelectAll" class="rounded bg-gray-800 border-gray-700 text-elite-gold focus:ring-0">
                                </th>
                                <th class="p-4">Staff Agent</th>
                                <th class="p-4">Student Name</th>
                                <th class="p-4">Region</th>
                                <th class="p-4">Course</th>
                                <th class="p-4">Contact</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <template x-for="row in filteredData">
                                <tr class="hover:bg-white/5 transition duration-150">
                                    <td x-show="user.role !== 'worker'" class="p-4">
                                        <input type="checkbox" :value="row.id" x-model="selectedIds" class="rounded bg-gray-800 border-gray-700 text-elite-gold focus:ring-0">
                                    </td>
                                    <td class="p-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-6 h-6 rounded-full bg-elite-green flex items-center justify-center text-[10px] text-white font-bold" x-text="row.staff_name.charAt(0)"></div>
                                            <span class="text-gray-300" x-text="row.staff_name"></span>
                                        </div>
                                    </td>
                                    <td class="p-4 font-medium text-white" x-text="row.name"></td>
                                    <td class="p-4" x-text="row.address"></td>
                                    <td class="p-4">
                                        <span class="px-2 py-1 rounded text-xs bg-gray-800 border border-gray-700 text-gray-300" x-text="row.course"></span>
                                    </td>
                                    <td class="p-4 font-mono text-xs" x-text="row.contact"></td>
                                    
                                    <td class="p-4 text-right">
                                        <button @click="openEditModal(row)" class="text-gray-500 hover:text-elite-gold transition">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div x-show="view === 'users'" class="max-w-2xl mx-auto" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            <div class="glass-panel rounded-2xl p-8 border-t-4 border-elite-gold">
                <h2 class="text-2xl font-semibold mb-2 text-white">Staff Management</h2>
                <p class="text-sm text-gray-400 mb-8 pb-4 border-b border-white/5">Create accounts for new data collectors or supervisors.</p>
                
                <form @submit.prevent="createUser" class="space-y-5">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Full Name</label>
                            <input x-model="newUser.fullName" placeholder="Staff Name" class="elite-input" required>
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Email (Login ID)</label>
                            <input x-model="newUser.username" placeholder="email@elitetransport.com" type="email" class="elite-input" required>
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Default Password</label>
                            <input x-model="newUser.password" placeholder="Create Password" class="elite-input" required>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                            <div>
                                <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Role</label>
                                <select x-model="newUser.role" class="elite-input bg-[#0D0D0D]">
                                    <option value="worker">Field Worker</option>
                                    <option value="admin">Admin (Supervisor)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Assigned Supervisor</label>
                                <select x-model="newUser.supervisorId" class="elite-input bg-[#0D0D0D] disabled:opacity-50" :disabled="newUser.role === 'admin'">
                                    <option value="">Select Supervisor...</option>
                                    <template x-for="u in adminList">
                                        <option :value="u.id" x-text="u.full_name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-elite-gold hover:bg-yellow-500 text-black font-bold py-4 rounded-xl mt-6 transition shadow-lg shadow-yellow-900/20">
                        CREATE ACCOUNT & SEND EMAIL
                    </button>
                </form>
                <div x-show="userMessage" class="mt-4 p-3 rounded border text-sm text-center"
                     :class="userMessageStatus === 'error' ? 'bg-red-900/20 border-red-900/50 text-red-400' : 'bg-green-900/20 border-green-900/50 text-green-400'"
                     x-text="userMessage"></div>
            </div>
        </div>

        <div x-show="showEditModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" style="display:none;">
            <div class="glass-panel w-full max-w-lg rounded-2xl p-6 relative">
                <h3 class="text-xl font-bold text-white mb-4">Edit Entry</h3>
                <form @submit.prevent="submitEdit" class="space-y-4">
                    
                    <div>
                        <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Full Name</label>
                        <input x-model="editData.name" class="elite-input" placeholder="Full Name" required>
                    </div>

                    <div>
                        <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Contact</label>
                        <input x-model="editData.contact" class="elite-input" placeholder="Contact" required>
                    </div>

                    <div>
                        <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Region</label>
                        <select x-model="editData.address" class="elite-input bg-[#0D0D0D]">
                            <option value="" disabled>Select Region</option>
                            <option>Ahafo Region</option>
                            <option>Ashanti Region</option>
                            <option>Bono Region</option>
                            <option>Bono East Region</option>
                            <option>Central Region</option>
                            <option>Eastern Region</option>
                            <option>Greater Accra Region</option>
                            <option>North East Region</option>
                            <option>Northern Region</option>
                            <option>Oti Region</option>
                            <option>Savannah Region</option>
                            <option>Upper East Region</option>
                            <option>Upper West Region</option>
                            <option>Volta Region</option>
                            <option>Western Region</option>
                            <option>Western North Region</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Course</label>
                        <input x-model="editData.course" class="elite-input" placeholder="Course of Study" required>
                    </div>

                    <div>
                        <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 ml-1">Level</label>
                        <select x-model="editData.level" class="elite-input bg-[#0D0D0D]">
                            <option value="" disabled>Select Level</option>
                            <option>Level 100</option>
                            <option>Level 200</option>
                            <option>Level 300</option>
                            <option>Level 400</option>
                            <option>Level 500</option>
                            <option>Level 600</option>
                            <option>Masters</option>
                        </select>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showEditModal = false" class="px-4 py-2 text-sm text-gray-400 hover:text-white">Cancel</button>
                        <button type="submit" class="bg-elite-gold text-black px-4 py-2 rounded text-sm font-bold hover:bg-yellow-500">Update</button>
                    </div>
                </form>
            </div>
        </div>

        <div x-show="showDelegateModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" style="display:none;">
            <div class="glass-panel w-full max-w-md rounded-2xl p-6 relative">
                <h3 class="text-xl font-bold text-white mb-2">Delegate Work</h3>
                <p class="text-xs text-gray-400 mb-6">Select a worker to assign <span class="text-elite-gold" x-text="selectedIds.length"></span> entries to.</p>
                
                <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar mb-6">
                    <template x-for="w in workersWithLoad">
                        <div @click="delegationTarget = w.id" 
                             class="p-3 rounded border cursor-pointer flex justify-between items-center transition"
                             :class="delegationTarget === w.id ? 'bg-elite-gold/20 border-elite-gold' : 'bg-white/5 border-transparent hover:bg-white/10'">
                            <div>
                                <p class="text-sm text-white font-medium" x-text="w.name"></p>
                                <p class="text-[10px] text-gray-500" x-text="w.role"></p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-mono font-bold" :class="w.load >= 150 ? 'text-red-400' : 'text-green-400'" x-text="w.load"></span>
                                <p class="text-[10px] text-gray-500">Entries</p>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" @click="showDelegateModal = false" class="px-4 py-2 text-sm text-gray-400 hover:text-white">Cancel</button>
                    <button type="button" @click="submitDelegate" class="bg-elite-gold text-black px-4 py-2 rounded text-sm font-bold hover:bg-yellow-500" :disabled="!delegationTarget">Assign</button>
                </div>
            </div>
        </div>

        <div x-show="showImportModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" style="display:none;">
            <div class="glass-panel w-full max-w-2xl rounded-2xl p-6 relative flex flex-col max-h-[90vh]">
                <h3 class="text-xl font-bold text-white mb-2">Map Columns</h3>
                <p class="text-xs text-gray-400 mb-4">Match the file headers to the system fields.</p>
                
                <div class="overflow-y-auto custom-scrollbar flex-1 space-y-4 pr-2">
                    <template x-for="field in importFields">
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1.5 ml-1" x-text="field.label"></label>
                            <select x-model="importMapping[field.key]" class="elite-input bg-[#0D0D0D]">
                                <option value="">-- Skip Column --</option>
                                <template x-for="header in fileHeaders">
                                    <option :value="header" x-text="header"></option>
                                </template>
                            </select>
                        </div>
                    </template>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-white/5">
                    <button type="button" @click="showImportModal = false" class="px-4 py-2 text-sm text-gray-400 hover:text-white">Cancel</button>
                    <button type="button" @click="processImport" class="bg-elite-gold text-black px-4 py-2 rounded text-sm font-bold hover:bg-yellow-500">
                        <span x-text="importing ? 'Importing...' : 'Start Import'"></span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        function app() {
            return {
                // REPLACE THIS URL WITH YOUR WORKER URL
                apiUrl: 'https://hugedatabase.elitetransportghana.workers.dev',
                
                token: localStorage.getItem('elite_token') || '',
                user: JSON.parse(localStorage.getItem('elite_user') || '{}'),
                view: 'entry', 
                
                auth: { username: '', password: '', error: '', newPassword: '', success: '' },
                form: { address:'', name:'', contact:'', course:'', level:'', numberOnRoll:'', customCourse:'' },
                newUser: { fullName:'', username:'', password:'', role:'worker', supervisorId:'' },
                
                stats: {},
                dataList: [],
                adminList: [],
                message: '', status: '', 
                userMessage: '', userMessageStatus: '',
                resetToken: '',

                selectedIds: [],
                showEditModal: false,
                editData: {},
                showDelegateModal: false,
                workersWithLoad: [],
                delegationTarget: '',

                // NEW STATES FOR FILTERS AND IMPORT
                filters: { course: '', level: '', region: '' },
                showImportModal: false,
                fileHeaders: [],
                importedData: [],
                importMapping: {},
                importing: false,
                importFields: [
                    { label: 'Full Name', key: 'name' },
                    { label: 'Contact Number', key: 'contact' },
                    { label: 'Region of Residence', key: 'address' },
                    { label: 'Course of Study', key: 'course' },
                    { label: 'Level', key: 'level' },
                    { label: 'Number on Roll', key: 'numberOnRoll' }
                ],

                // --- NEW FILTER LOGIC ---
                get filteredData() {
                    return this.dataList.filter(row => {
                        const matchCourse = this.filters.course === '' || row.course === this.filters.course;
                        const matchLevel = this.filters.level === '' || row.level === this.filters.level;
                        const matchRegion = this.filters.region === '' || row.address === this.filters.region;
                        return matchCourse && matchLevel && matchRegion;
                    });
                },

                get uniqueCourses() {
                    return [...new Set(this.dataList.map(item => item.course))].sort();
                },
                get uniqueLevels() {
                    return [...new Set(this.dataList.map(item => item.level))].sort();
                },
                get uniqueRegions() {
                    return [...new Set(this.dataList.map(item => item.address))].sort();
                },
                // ------------------------

                init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.resetToken = urlParams.get('resetToken');

                    if (this.resetToken) {
                        this.view = 'reset';
                    } else if(this.token && this.user.role !== 'worker') { 
                        this.view = 'stats'; 
                        this.fetchStats(); 
                    } else if(this.token && this.user.role === 'worker') {
                        this.view = 'entry';
                    } else {
                        this.view = 'login';
                    }

                    if(this.token && this.user.role === 'main_admin') {
                        this.fetchUsers();
                    }
                },

                async login() {
                    try {
                        const res = await fetch(`${this.apiUrl}/login`, {
                            method: 'POST', body: JSON.stringify(this.auth)
                        });
                        if(!res.ok) throw new Error('Invalid Login credentials');
                        const data = await res.json();
                        
                        this.token = data.token;
                        this.user = { name: data.name, role: data.role };
                        localStorage.setItem('elite_token', this.token);
                        localStorage.setItem('elite_user', JSON.stringify(this.user));
                        
                        this.view = data.role === 'worker' ? 'entry' : 'stats';
                        if(data.role !== 'worker') this.fetchStats();
                        if(data.role === 'main_admin') this.fetchUsers();
                    } catch(e) {
                        this.auth.error = e.message;
                    }
                },

                async sendResetLink() {
                    this.auth.error = '';
                    this.auth.success = '';
                    try {
                        const res = await fetch(`${this.apiUrl}/forgot-password`, {
                            method: 'POST', body: JSON.stringify({ email: this.auth.username })
                        });
                        if(!res.ok) throw new Error('Failed to request reset');
                        this.auth.success = 'If an account exists, a reset link has been sent.';
                    } catch(e) {
                         this.auth.error = e.message;
                    }
                },

                async resetPassword() {
                     this.auth.error = '';
                     try {
                        const res = await fetch(`${this.apiUrl}/reset-password`, {
                            method: 'POST', 
                            body: JSON.stringify({ token: this.resetToken, newPassword: this.auth.newPassword })
                        });
                        
                        if (res.status === 404) throw new Error('System update required. (Deploy Worker)');
                        if (!res.ok) throw new Error('Invalid or expired token');
                        
                        this.auth.success = 'Password updated! Redirecting to login...';
                        
                        setTimeout(() => {
                            window.location.href = window.location.pathname; 
                        }, 2000);

                     } catch(e) {
                         this.auth.error = e.message;
                     }
                },

                logout() {
                    this.token = '';
                    localStorage.removeItem('elite_token');
                    window.location.href = window.location.pathname;
                },

                async submitEntry() {
                    this.message = 'Syncing to Database...';
                    this.status = 'loading';
                    try {
                        const res = await fetch(`${this.apiUrl}/submit`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.form)
                        });
                        const data = await res.json();
                        if(!res.ok) throw new Error(data.error);
                        
                        this.status = 'success';
                        this.message = 'Entry Recorded Successfully';
                        this.form = { address:'', name:'', contact:'', course:'', level:'', numberOnRoll:'', customCourse:'' };
                        if(this.user.role !== 'worker') this.fetchStats();
                    } catch(e) {
                        this.status = 'error';
                        this.message = e.message;
                    }
                },

                async fetchStats() {
                    const res = await fetch(`${this.apiUrl}/admin/stats`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    this.stats = await res.json();
                    
                    const dataRes = await fetch(`${this.apiUrl}/admin/data`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    this.dataList = await dataRes.json();
                },

                async fetchUsers() {
                    const res = await fetch(`${this.apiUrl}/admin/users`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    const allUsers = await res.json();
                    this.adminList = allUsers.filter(u => u.role === 'admin' || u.role === 'main_admin');
                },

                async createUser() {
                    this.userMessage = 'Creating User & Sending Email...';
                    this.userMessageStatus = 'loading';
                    try {
                        const res = await fetch(`${this.apiUrl}/admin/create-user`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newUser)
                        });
                        
                        const data = await res.json(); 
                        if(!res.ok) throw new Error(data.error || 'Failed'); 

                        this.userMessageStatus = 'success';
                        this.userMessage = 'User Created & Email Sent!';
                        this.newUser = { fullName:'', username:'', password:'', role:'worker', supervisorId:'' };
                        this.fetchUsers(); 
                    } catch(e) {
                        this.userMessageStatus = 'error';
                        this.userMessage = e.message;
                    }
                },

                toggleSelectAll(e) {
                    if (e.target.checked) {
                        this.selectedIds = this.filteredData.map(row => row.id); // CHANGED to match filtered view
                    } else {
                        this.selectedIds = [];
                    }
                },

                openEditModal(row) {
                    this.editData = { ...row }; 
                    this.showEditModal = true;
                },

                async submitEdit() {
                    try {
                        const res = await fetch(`${this.apiUrl}/admin/update-entry`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.editData)
                        });
                        if(!res.ok) throw new Error('Update Failed');
                        this.showEditModal = false;
                        this.fetchStats(); 
                    } catch(e) {
                        alert(e.message);
                    }
                },

                async openDelegateModal() {
                    try {
                        const res = await fetch(`${this.apiUrl}/admin/workers-load`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        this.workersWithLoad = await res.json();
                        this.showDelegateModal = true;
                    } catch(e) {
                        alert("Could not load workers list");
                    }
                },

                async submitDelegate() {
                    try {
                        const res = await fetch(`${this.apiUrl}/admin/delegate`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                entryIds: this.selectedIds,
                                targetWorkerId: this.delegationTarget
                            })
                        });
                        if(!res.ok) throw new Error('Delegation Failed');
                        
                        this.showDelegateModal = false;
                        this.selectedIds = []; 
                        this.delegationTarget = '';
                        this.fetchStats(); 
                        alert("Work delegated successfully");
                    } catch(e) {
                        alert(e.message);
                    }
                },

                // --- NEW IMPORT LOGIC ---
                handleFileUpload(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        
                        if (jsonData.length > 0) {
                            this.fileHeaders = jsonData[0];
                            this.importedData = jsonData.slice(1);
                            
                            this.importMapping = {};
                            this.importFields.forEach(f => this.importMapping[f.key] = '');
                            
                            this.showImportModal = true;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },

                async processImport() {
                    this.importing = true;
                    const phoneRegex = /^(?:\+?233|0)(2\d|3\d|5\d)\d{7}$/;
                    let successCount = 0;

                    for (const row of this.importedData) {
                        // Map Data based on user selection
                        const entry = {};
                        let hasPhone = false;

                        for (const field of this.importFields) {
                            const header = this.importMapping[field.key];
                            if (header) {
                                const colIndex = this.fileHeaders.indexOf(header);
                                entry[field.key] = row[colIndex] || ''; // Allow empty strings
                            } else {
                                entry[field.key] = '';
                            }
                        }

                        // Validate Phone
                        if (entry.contact) {
                            // Only strip whitespace and dashes, KEEP '233' or '+' if present for regex
                            let cleanContact = String(entry.contact).replace(/[\s-]/g, '');
                            
                            if (phoneRegex.test(cleanContact)) {
                                // Normalize for DB: Ensure it starts with 0
                                if (cleanContact.startsWith('+233')) {
                                    cleanContact = '0' + cleanContact.substring(4);
                                } else if (cleanContact.startsWith('233')) {
                                    cleanContact = '0' + cleanContact.substring(3);
                                }
                                
                                entry.contact = cleanContact;
                                hasPhone = true;
                            }
                        }

                        if (hasPhone) {
                            try {
                                await fetch(`${this.apiUrl}/submit`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${this.token}`, 'Content-Type': 'application/json' },
                                    body: JSON.stringify(entry)
                                });
                                successCount++;
                            } catch (e) {
                                console.log('Skipped duplicate or error row');
                            }
                        }
                    }

                    this.importing = false;
                    this.showImportModal = false;
                    this.$refs.fileInput.value = ''; // Reset input
                    alert(`Import Complete. ${successCount} entries added.`);
                    this.fetchStats();
                }
            }
        }
    </script>
</body>
</html>